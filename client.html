<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>jop's chat app</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: "Inter", sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
        }
        .chat-container {
            max-width: 600px;
            margin: 2rem auto;
            background-color: #2d3748;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            border: 1px solid #4a5568;
        }
        .chat-box {
            height: 400px;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            background-color: #2c2c2c;
        }
        .message {
            background-color: #4a5568;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            word-wrap: break-word;
            max-width: 85%;
        }
        .message.self {
            background-color: #3b82f6; /* Blue for own messages */
            align-self: flex-end;
            margin-left: auto; /* Push to right */
        }
        .message.other {
            align-self: flex-start;
            margin-right: auto; /* Push to left */
        }
        .message-username {
            font-weight: bold;
            margin-bottom: 0.25rem;
            color: #a0aec0; /* Lighter gray for username */
            font-size: 0.875rem; /* Smaller username font */
        }
        .message.self .message-username {
            color: #bfdbfe; /* Lighter blue for own username */
        }
        .system-message {
            text-align: center;
            font-style: italic;
            color: #a0aec0;
            font-size: 0.8rem;
            padding: 0.5rem;
        }
        .input-area {
            display: flex;
            padding: 1rem;
            gap: 0.5rem;
            border-top: 1px solid #4a5568;
        }
        .input-area input[type="text"] {
            flex-grow: 1;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #6b7280;
            background-color: #3f475a;
            color: #e2e8f0;
            outline: none;
            transition: border-color 0.2s ease-in-out;
        }
        .input-area input[type="text"]:focus {
            border-color: #3b82f6;
        }
        .input-area button {
            background-color: #3b82f6;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            border: none;
        }
        .input-area button:hover {
            background-color: #2563eb;
        }
        .connection-status {
            text-align: center;
            font-weight: bold;
            padding: 0.5rem;
            color: #fca5a5;
            background-color: #4a2d2c;
        }
        .connection-status.connected {
            color: #a7f3d0;
            background-color: #2c4a2d;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="chat-container">
        <h1 class="text-3xl font-extrabold text-center text-white p-6 border-b border-gray-700">jopnyth's chat app</h1>

        <div id="connectionStatus" class="connection-status">
            Disconnected
        </div>

        <div class="p-4 bg-gray-700">
            <label for="usernameInput" class="block text-gray-300 text-sm font-medium mb-2">enter your username:</label>
            <input type="text" id="usernameInput" placeholder="your name" class="w-full p-2 rounded-md bg-gray-600 border border-gray-500 text-white focus:outline-none focus:ring-1 focus:ring-blue-500">
        </div>

        <div id="chatBox" class="chat-box">
        </div>

        <div class="input-area">
            <input type="text" id="messageInput" placeholder="type your message..." disabled>
            <button id="sendMessageBtn" disabled>Send</button>
        </div>
    </div>

    <script>
        const chatBox = document.getElementById('chatBox');
        const usernameInput = document.getElementById('usernameInput');
        const messageInput = document.getElementById('messageInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const connectionStatus = document.getElementById('connectionStatus');

        let ws;
        let username = "Anonymous";

        function updateConnectionStatus(status, isConnected = false) {
            connectionStatus.textContent = status;
            if (isConnected) {
                connectionStatus.classList.remove('text-red-300', 'bg-red-800');
                connectionStatus.classList.add('connected');
            } else {
                connectionStatus.classList.remove('connected');
                connectionStatus.classList.add('text-red-300', 'bg-red-800');
            }
        }

        function addMessage(user, msg, isSelf = false) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            messageDiv.classList.add(isSelf ? 'self' : 'other');

            const usernameSpan = document.createElement('span');
            usernameSpan.classList.add('message-username');
            usernameSpan.textContent = user;

            const messageText = document.createElement('p');
            messageText.textContent = msg;

            messageDiv.appendChild(usernameSpan);
            messageDiv.appendChild(messageText);
            chatBox.appendChild(messageDiv);

            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function addSystemMessage(msg) {
            const systemDiv = document.createElement('div');
            systemDiv.classList.add('system-message');
            systemDiv.textContent = msg;
            chatBox.appendChild(systemDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        usernameInput.addEventListener('change', function() {
            if (usernameInput.value.trim() !== "") {
                username = usernameInput.value.trim();
                addSystemMessage(`your username set to: ${username}.`);
                messageInput.disabled = false;
                sendMessageBtn.disabled = false;
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ type: 'username_change', newUsername: username }));
                }
            } else {
                username = "Anonymous";
                addSystemMessage("username reset to Anonymous.");
            }
        });

        function connectWebSocket() {
            updateConnectionStatus('connecting...', false);
            ws = new WebSocket('ws://localhost:8765'); 

            ws.onopen = function() {
                updateConnectionStatus('Connected', true);
                addSystemMessage("vonnected to the chat server! you may begin talking.");
                messageInput.disabled = false;
                sendMessageBtn.disabled = false;
                ws.send(JSON.stringify({ type: 'username_change', newUsername: username }));
            };

            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                if (data.type === 'chat_message') {
                    addMessage(data.username, data.message, data.username === username);
                } else if (data.type === 'system_message') {
                    addSystemMessage(data.message);
                }
            };

            ws.onclose = function() {
                updateConnectionStatus('disconnected, server probably crashed. sigh..', false);
                addSystemMessage("disconnected from the chat server. trying to reconnect in 5 seconds...");
                messageInput.disabled = true;
                sendMessageBtn.disabled = true;
                setTimeout(connectWebSocket, 5000);
            };

            ws.onerror = function(err) {
                console.error("WebSocket error:", err);
                updateConnectionStatus('connection error. check console asap.', false);
                ws.close();
            };
        }

        sendMessageBtn.addEventListener('click', function() {
            const message = messageInput.value.trim();
            if (message !== "" && ws && ws.readyState === WebSocket.OPEN) {
                const chatData = {
                    type: 'chat_message',
                    username: username,
                    message: message
                };
                ws.send(JSON.stringify(chatData));
                messageInput.value = '';
            } else if (ws && ws.readyState !== WebSocket.OPEN) {
                addSystemMessage("not connected to server. can't send messages");
            }
        });

        messageInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                sendMessageBtn.click();
            }
        });

        connectWebSocket();
    </script>
</body>
</html>
